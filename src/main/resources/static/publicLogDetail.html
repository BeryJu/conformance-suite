<!DOCTYPE html>
<html>

<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta charset="UTF-8">
<title>OIDF Conformance: Test Detail</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.css" integrity="sha256-HS1ihgXZ6qfUcS5BTehJhV81EZR+I5Q6zx5yGdEqbp0=" crossorigin="anonymous" />

<link rel="stylesheet" type="text/css" href="css/layout.css">

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js" integrity="sha256-vS9J2VYhvwAfh2znnLdkhemFPEpx6YoZEhExqBPT5ys=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.7/chroma.min.js" integrity="sha256-5lUH8axVgWCBbZPof5CbN9eSWye/cPLd4G1feQ6l6VU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.js" integrity="sha256-MRXUjKPZRRi+LHqT1KY/uoxyFF2JLOp2b329vX4p+2Y=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js" integrity="sha256-9I2FxupwHkF6hXzZKS3hLCwP95XFukX3EnxRzGqXzz0=" crossorigin="anonymous"></script>

<script type="text/javascript" src="js/fapi.ui.js"></script>
</head>

<body>

	<div class="pageHeader container-fluid">
		<div class="row-fluid">
			<div class="col-md-8">
				<a href="index.html"><img src="/images/openid.png"></a>
			</div>
			<div id="userInfoHolder" class="col-md-4 text-right"></div>
		</div>
	</div>
	<div class="clearfix"></div>

	<!-- error modal -->
	<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="errorLabel">Error</h4>
				</div>
				<div class="modal-body">
					Error: <span id="errorMessage"></span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- loading modal -->
	<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title" id="loadingLabel">Loading...</h4>
				</div>
				<div class="modal-body">
					<div class="text-center">
						<img src="/images/spinner.gif" width="100px" height="30px" />
					</div>
					<div>
						<span id="loadingMessage"></span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- resident DOM -->
	<div class="container-fluid">
		<div id="logDetail">
			<div class="header"></div>
			<div class="logContent container-fluid">
				<!-- log items are rendered here -->
			</div>
		</div>
	</div>

	<script type="text/javascript">
		function getLogs(testId) {

			return $.ajax({
				type: 'GET',
				url: "/public/api/log/" + encodeURIComponent(testId) + ( FAPI_UI.latestTestEntry > 0 ? '?since=' + encodeURIComponent(FAPI_UI.latestTestEntry) : ''),
				data: {},
				success: function(data) {

					// clear any existing log items
					//$('#logDetail .logContent').html('');

					if (data.length > 0) {
						// we got some potentially new test data, reload faster
						FAPI_UI.resetReloadPause();
					} else {
						// we didn't get new data, slow down
						FAPI_UI.incrementReloadPause();
					}

					$.each(data, function(i, item) {

					    var existing = $('[data-item-entry-id="'+item._id+'"]');

					    // check to see if we've seen it before
					    if (existing.length == 0) {

	                        if (item.blockId && item.startBlock) {
	                        	// render the start-block special entry
	                        	var el = $(FAPI_UI.logTemplates.START_BLOCK({
	                        		item: item
	                        	}));
	                        } else {
		                        // render the base element
		                        var el = $(FAPI_UI.logTemplates.PUBLIC_LOG_DETAIL({
		                            item: item
		                        }));
	                        }

	                        $('#logDetail .logContent').append(el);

	                        // see if we've got any "extra" bits that we want to display in a block
	                        var more = _.pickBy(item, function(value, key) {
	                            return !_.includes(FAPI_UI.visibleFields, key) && !key.startsWith("_");
	                        });

	                        if (!_.isEmpty(more)) {
	                            // we have extra fields so let's attach them
	                            var moreButton = $(FAPI_UI.logTemplates.MORE_BUTTON({
	                                more: more,
	                                item: item
	                            }));
	                            var moreInfo = $(FAPI_UI.logTemplates.MORE({
	                                more: more,
	                                item: item
	                            }));

	                            $('.moreButtonContainer', el).append(moreButton);
	                            $('.moreInfoContainer', el).append(moreInfo);

	                            // wire up the button
	                            $('.moreBtn', el).click(function(evt) {
	                                if ($(this).data('activated')) {
	                                    // it's already been activated, need to hide things
	                                    $('.moreInfo', el).hide(); // hide the content
	                                    $('.glyphicon', this).removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
	                                    $(this).data('activated', false);
	                                } else {
	                                    // need to show the collapsed entity
	                                    $('.moreInfo', el).show(); // show the content
	                                    $('.glyphicon', this).removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
	                                    $(this).data('activated', true);
	                                }
	                            });

	                            // prettyprint any raw JSON values
	                            PR.prettyPrint();
	                        }

	                        // write down the "last" log entry we've seen so far so we don't have to re-fetch it at all; if it does happen we can ignore it
                            FAPI_UI.latestTestEntry = _.max([FAPI_UI.latestTestEntry, item.time]);

					    } else {
					    	   // skipping an existing element
					    	   //console.log('Skipping existing: ' + item._id);
					    	   // TODO: update log entries that have been updated (such as an automated placeholder fulfillment)
					    }

					});

				    // total the amounts for display
				    var allResults = $('[data-entry-result]').map(function() { return $(this).data('entryResult'); }).get();
				    var resultTotals = _.countBy(allResults, _.identity());

				    var possibleResults = ['success', 'failure', 'warning', 'review', 'info'];
				    var results = '';
				    _.each(possibleResults, function(result) {
				    	   results += FAPI_UI.logTemplates.SUMMARY({result: result, value: resultTotals[result]});
				    });
				    $('#testResultSummary').html(results);
                    // count up any "image required" items

                    var uploadCount = $('[data-image-required]').length;
                    if (uploadCount) {
                        $('#uploadCount').html(uploadCount);
                        $('#uploadBtn').addClass('btn-info');
                        $('#uploadBtn').removeClass('btn-default');
                    } else {
                        $('#uploadCount').html('');
                        $('#uploadBtn').removeClass('btn-info');
                        $('#uploadBtn').addClass('btn-default');
                    }
                 },
				error: function(jqxhr, status, error) {
					FAPI_UI.showError(jqxhr.responseJSON ? jqxhr.responseJSON : {
						error: error
					});
				}
			});
		}

		function getHeader(testId) {
			// this is the page header, fill it in with log details
			return $.ajax({
				type: 'GET',
				url: '/public/api/info/' + encodeURIComponent(testId),
				data: {},
				success: function(data) {

					// save the status for the 'active' panel later
					if (data.status) {
						if (FAPI_UI.status != data.status.toLowerCase()) {
						    FAPI_UI.resetReloadPause(); // the status changed, might want to pay more attention
							FAPI_UI.status = data.status.toLowerCase();
						}
					}

					// see if we've already rendered this
					var existing = $('#logDetail .header [data-instance-id="'+testId+'"]');

					if (existing.length == 0) {
	                    $('#logDetail .header').html(FAPI_UI.logTemplates.PUBLIC_LOG_START({
	                        test: data
	                    }));

	                    $('#logDetail .header [data-toggle="tooltip"]').tooltip({
	                        container: 'body'
	                    });

	                    $('#downloadBtn').click(function(evt) {
	                        evt.preventDefault();
	                        window.open('/public/api/log/export/' + encodeURIComponent(testId));
	                    });

	                    if (data.planId) {
	                        $('#planBtn').click(function(evt) {
	                            evt.preventDefault();
	                            window.location.assign('/publicPlanDetail.html?plan=' + encodeURIComponent(data.planId));
	                        });
	                        $('#planBtn').show();
	                                }
					}

					// update the status and result regardless of whether we rendered the header in full
				    $('#logDetail .header #testStatusAndResult').html(FAPI_UI.logTemplates.TEST_STATUS({test: data}));

				},
				error: function(jqxhr, status, error) {
					FAPI_UI.showError(jqxhr.responseJSON ? jqxhr.responseJSON : {
						error: error
					});
				}
			});
		}

		$(document).ready(function() {
			var urlParams = new URLSearchParams(window.location.search);
			var testId = urlParams.get('log');

			FAPI_UI.showBusy();

			FAPI_UI.loadPublicLogDetailTemplates() // Load the templates
			.then(function() {
				return getHeader(testId); // render the header, which includes test info
			}).then(function() {
				return getLogs(testId); // render the log entries themselves
			}).always(function() {
				FAPI_UI.hideBusy();
			});

			var clipboard = new ClipboardJS('.btn-clipboard');
			clipboard.on('success', function(e) {
				console.log(e);
			});
			clipboard.on('error', function(e) {
				console.log(e);
			});
		});
	</script>


	<footer class="pageFooter">
		<span class="muted">OpenID Foundation conformance suite</span>
	</footer>

</body>

</html>
