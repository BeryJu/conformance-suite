<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>HEART Test Suite</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  

	    <div class="container">

      <div class="starter-template">
      
        <h1>HEART Test Framework</h1>

		<textarea id="config">{}</textarea>
		
		<div id="launch-buttons"></div>

		<h3>Running tests</h3>

		<button class="btn" id="refresh">Refresh</button>

		<div id="running-tests"></div>

      </div>

    </div><!-- /.container -->
	




    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


<script type="text/javascript">

$(function() {
	
	$.getJSON('runner/available', function(data) {
		console.log('available: ', data);
		
		_.each(data, function(testName) {
			$('#launch-buttons').append('<button class="btn">Start: ' + testName + '</button>')
				.click(function() {
					console.log('Button clicked: ' + testName);
					$.ajax({url: 'runner/start?test=' + encodeURIComponent(testName),
							type: 'POST',
							contentType: 'application/json',
							data: $('#config').val(),
							success: function(data, status) {
								console.log('start results: ', data);
								updateRunningTable();
							},
							dataTyle: 'json'
					});
				});
		});
	});
	
	updateRunningTable();
	
	$('#refresh').click(function(event) {
		updateRunningTable();
	});
	
});

function updateRunningTable() {
	$.getJSON('runner/running', function(data) {
			console.log('running: ', data);
			$('#running-tests').html('');
			
			_.each(data, function(testId) {
				$.getJSON('runner/status/' + encodeURIComponent(testId), function(status) {
					console.log('displaying test: ' + status);
					$('#running-tests').append('<div id="' + status.id + '"><b>' + status.name + '</b> (<i>' + status.id + '</i>): ' + status.status + '</div>');
					$.getJSON('runner/browser/' + encodeURIComponent(testId), function(browser) {
						$('#' + browser.id).append('<ul>');
						_.each(browser.urls, function(url) {
							$('#' + browser.id).append('<li><a href="#">' + url + '</a></li>').click(function(event) {
								event.preventDefault();
								
								
								
								var win = window.open(url, '_blank');
								
								if (win) {
									win.focus();
									$.ajax({url: 'runner/browser/' + encodeURIComponent(testId) + '/visit?url=' + encodeURIComponent(url),
										type: 'POST',
										success: function(data, status) {
											console.log('Status: ', status);													
											updateRunningTable();
										}
									});
								} else {
									// couldn't open the link?
									console.log("Couldn't launch window");
								}
								
							});
						});						
						$('#' + browser.id).append('</ul>');
					});
				});
			});
	});
}


</script>


  </body>
</html>