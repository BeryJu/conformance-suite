<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>FAPI Test Suite</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<link rel="stylesheet" type="text/css" href="css/layout.css">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  	
  	<header onClick="FAPI_UI.goHome()"></header>

  	<!-- Start -->
    <script type="text/template" id="indexTemplate_Start">  
        <h1>
            <div class="key">FAPI Test Framework</div>
        </h1>
    </script>

    <!-- Form -->
    <script type="text/template" id="indexTemplate_Form">
    	<div>
			<textarea id="config">{}</textarea>
			<input type="text" id="alias" placeholder="alias"></input>
			<div id="launch-buttons"></div>
        </div>
    </script>

    <!-- Running Tests -->
    <script type="text/template" id="indexTemplate_RunningTests">
    	<h3>Running tests</h3>
        <div>
			<button class="btn" id="refresh">Refresh</button>
			<div id="running-tests"></div>
        </div>
    </script>

    <!-- Footer -->
    <script type="text/template" id="indexTemplate_End">
    	<div>
            <a href="logs.html" class="btn btn-info">View all available logs.</a>
        </div>
    </script>

    <!-- resident DOM -->
    <div class="mainHolder">
        <div id="homePage">
        	<div class="a"></div>
        	<div class="b"></div>
        	<div class="c"></div>
        	<div class="d"></div>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/javascript" src="js/fapi.ui.js"></script>

	<script type="text/javascript">
		
		/**
	     * 
	     */
	    $(document).ready(function(){
	        FAPI_UI.loadHomepageTemplates();
	        $('#homePage .a').append(FAPI_UI.logTemplates.INDEX_START({}));
	        $('#homePage .b').append(FAPI_UI.logTemplates.INDEX_FORM({}));
	        $('#homePage .c').append(FAPI_UI.logTemplates.INDEX_RUNNNING_TESTS({}));
	        $('#homePage .d').append(FAPI_UI.logTemplates.INDEX_END({}));
	    });

	    /**
	     * 
	     */
		$(function() {
			
			$.getJSON('runner/available', function(data) {
				console.log('available: ', JSON.stringify(data));

				_.each(data, function(testName) {
					var btn = $('<button class="btn">Create: ' + testName + '</button>');
					$('#launch-buttons').append(btn);
					btn.click(function() {
						console.log('Button clicked: ' + testName);
						$.ajax({url: 'runner/?test=' + encodeURIComponent(testName) + '&alias=' + encodeURIComponent($('#alias').val()),
								type: 'POST',
								contentType: 'application/json',
								data: $('#config').val(),
								success: function(data, status) {
									
									console.log('start results:: ', JSON.stringify(data));
									updateRunningTable();
								},
								dataTyle: 'json'
						});
					});
				});
			});
			
			updateRunningTable();
			
			$('#refresh').click(function(event) {
				updateRunningTable();
			});
			
		});

		/**
	     * 
	     */
		function updateRunningTable() {
			$.getJSON('runner/running', function(data) {
				console.log('running: ', JSON.stringify(data));
				$('#running-tests').html('');
				
				_.each(data, function(testId) {
					$.getJSON('runner/' + encodeURIComponent(testId), function(status) {
						console.log('displaying test: ' + status);
						$('#running-tests').append('<div id="' + status.id + '"><b>' + status.name + '</b> (<i>' + status.id + '</i>): ' + status.status + ' / ' + status.result + '</div>');
						
						if (status.result == 'FAILED') {
							$('#' + status.id).addClass('bg-danger');
						} else if (status.result == 'PASSED') {
							$('#' + status.id).addClass('bg-success');
						} else if (status.status == 'WAITING') {
							$('#' + status.id).addClass('bg-warning');
						} else if (status.status == 'CONFIGURED') {
							$('#' + status.id).addClass('bg-info');
						}
						
						// list of exposed values
						var exposed = $('<ul class="exposed"></ul>');
						$('#' + status.id).append(exposed);
						_.each(status.exposed, function(val, key) {
			                  $(exposed).append('<li><b>' + key + '<b>: <i>' + val + '</i></li>');
						});
						
						var start = $('<button class="btn btn-success">Start</button>');
						$('#' + status.id).append(start);
						start.click(function (event) {
						    $.ajax({url: 'runner/' + encodeURIComponent(testId),
						    	type: 'POST',
						    	success: function(data, status) {
	                                console.log('Status: ', status);                                                    
	                                updateRunningTable();
						    	}
						    });
						});
						var stop = $('<button class="btn btn-danger">Stop</button>');
	                    $('#' + status.id).append(stop);
	                    stop.click(function (event) {
	                        $.ajax({url: 'runner/' + encodeURIComponent(testId),
	                            type: 'DELETE',
	                            success: function(data, status) {
	                                console.log('Status: ', status);                                                    
	                                updateRunningTable();
	                            }
	                        });
	                    });
	                    
	                    $('#' + status.id).append('<a href="log-detail.html?log=' + encodeURIComponent(testId) + '" class="btn btn-info">View log</a>');
						
						$.getJSON('runner/browser/' + encodeURIComponent(testId), function(browser) {
							var b = $('<ul class="browser"></ul>');
							$('#' + status.id).append(b);
							_.each(browser.urls, function(url) {
								var link = $('<li><a href="#">Go to URL: ' + url + '</a></li>');
								$(b).append(link);
								link.click(function(event) {
									event.preventDefault();
									var win = window.open(url, '_blank');
									
									if (win) {
										win.focus();
										$.ajax({url: 'runner/browser/' + encodeURIComponent(testId) + '/visit?url=' + encodeURIComponent(url),
											type: 'POST',
											success: function(data, status) {
												console.log('Status: ', status);													
												updateRunningTable();
											}
										});
									} else {
										// couldn't open the link?
										console.log("Couldn't launch window");
									}
									
								});
							});						
						});
					});
				});
			});
		}

	</script>

  </body>
</html>
