<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>FAPI Test Suite</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  

	    <div class="container">

      <div class="starter-template">
      
        <h1>FAPI Test Framework</h1>

		<textarea id="config">{}</textarea>
		
		<input type="text" id="alias"></input>
		
		<div id="launch-buttons"></div>

		<h3>Running tests</h3>

		<button class="btn" id="refresh">Refresh</button>

		<div id="running-tests"></div>

      </div>

    </div><!-- /.container -->
	




    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


<script type="text/javascript">

$(function() {
	
	$.getJSON('runner/available', function(data) {
		console.log('available: ', data);
		
		_.each(data, function(testName) {
			var btn = $('<button class="btn">Create: ' + testName + '</button>');
			$('#launch-buttons').append(btn);
			btn.click(function() {
				console.log('Button clicked: ' + testName);
				$.ajax({url: 'runner/?test=' + encodeURIComponent(testName) + '&alias=' + encodeURIComponent($('#alias').val()),
						type: 'POST',
						contentType: 'application/json',
						data: $('#config').val(),
						success: function(data, status) {
							console.log('start results: ', data);
							updateRunningTable();
						},
						dataTyle: 'json'
				});
			});
		});
	});
	
	updateRunningTable();
	
	$('#refresh').click(function(event) {
		updateRunningTable();
	});
	
});

function updateRunningTable() {
	$.getJSON('runner/running', function(data) {
			console.log('running: ', data);
			$('#running-tests').html('');
			
			_.each(data, function(testId) {
				$.getJSON('runner/' + encodeURIComponent(testId), function(status) {
					console.log('displaying test: ' + status);
					$('#running-tests').append('<div id="' + status.id + '"><b>' + status.name + '</b> (<i>' + status.id + '</i>): ' + status.status + ' / ' + status.result + '</div>');
					
					if (status.result == 'FAILED') {
						$('#' + status.id).addClass('bg-danger');
					} else if (status.result == 'PASSED') {
						$('#' + status.id).addClass('bg-success');
					} else if (status.status == 'WAITING') {
						$('#' + status.id).addClass('bg-warning');
					} else if (status.status == 'CONFIGURED') {
						$('#' + status.id).addClass('bg-info');
					}
					
					// list of exposed values
					$('#' + status.id).append('<ul class="exposed">');
					_.each(status.exposed, function(val, key) {
		                  $('#' + status.id).append('<li><b>' + key + '<b>: <i>' + val + '</i></li>');
					});
			        $('#' + status.id).append('</ul>');
					
					var start = $('<button>Start</button>');
					$('#' + status.id).append(start);
					start.click(function (event) {
					    $.ajax({url: 'runner/' + encodeURIComponent(testId),
					    	type: 'POST',
					    	success: function(data, status) {
                                console.log('Status: ', status);                                                    
                                updateRunningTable();
					    	}
					    });
					});
					var stop = $('<button>Stop</button>');
                    $('#' + status.id).append(stop);
                    stop.click(function (event) {
                        $.ajax({url: 'runner/' + encodeURIComponent(testId),
                            type: 'DELETE',
                            success: function(data, status) {
                                console.log('Status: ', status);                                                    
                                updateRunningTable();
                            }
                        });
                    });
					
					$.getJSON('runner/browser/' + encodeURIComponent(testId), function(browser) {
						$('#' + status.id).append('<ul class="browser">');
						_.each(browser.urls, function(url) {
							$('#' + browser.id + ' ul.browser').append('<li>');
							var link = $('<a href="#">Go to URL: ' + url + '</a>');
							$('#' + browser.id + ' ul.browser').append(link);
							link.click(function(event) {
								event.preventDefault();
								var win = window.open(url, '_blank');
								
								if (win) {
									win.focus();
									$.ajax({url: 'runner/browser/' + encodeURIComponent(testId) + '/visit?url=' + encodeURIComponent(url),
										type: 'POST',
										success: function(data, status) {
											console.log('Status: ', status);													
											updateRunningTable();
										}
									});
								} else {
									// couldn't open the link?
									console.log("Couldn't launch window");
								}
								
							});
							$('#' + browser.id + ' ul.browser').append('</li>');
						});						
						$('#' + status.id).append('</ul>');
					});
				});
			});
	});
}


</script>


  </body>
</html>