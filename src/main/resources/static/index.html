<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>FAPI Test Suite</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<link rel="stylesheet" type="text/css" href="css/layout.css">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  	
  	<!-- resident DOM -->
	<a href="index.html"><header></header></a>

    <div id="busy">
    	<div class="activityIndicator">Please wait</div>
    </div>

    <div class="mainHolder">
        <div id="homePage">
 			<h1>FAPI Test Framework</h1>
			<div>
				<form action="/logout" method="post" class="form-inline">
					<input type="submit" class="btn btn-sm btn-primary" value="Logout">
				</form>
			</div>
			<br/>
	        <div>
				<textarea id="config" placeholder="{JSON data}"></textarea>
				<input type="text" id="alias" placeholder="alias"></input>
				<!-- render available test launch options here -->
				<div id="launch-buttons"></div>
	        </div>

	        <hr />

	        <h3>Running tests</h3>
	        <div>
				<button class="btn" id="refresh">Refresh</button>
				<!-- render tests to here -->
				<div id="running-tests"></div>
	        </div>

	        <hr />

	        <div>
	            <a href="logs.html" class="btn btn-info">View all available logs.</a>
	        </div>

        </div>
    </div>

    <!-- Templates -->
    <!-- Test Button -->
    <script type="text/template" id="indexTemplate_TestButton">  
        <button class="btn" id="createTestBtn-<%- index %>">Create <%- testName %></button>
    </script>

    <!-- Running Test: Main -->
    <script type="text/template" id="indexTemplate_RunningTest">  
		<div id="<%- testStatus.id %>" class="testResult result-<%- testStatus.result.toLowerCase() %>">
			<b><%- testStatus.name %></b> (<i><%- testStatus.id %></i>): <%- testStatus.status %> / <%- testStatus.result %>
			<ul class="exposed"></ul>
			<button class="btn start">START</button>
    		<button class="btn stop">STOP</button>
    		<a href="log-detail.html?log=<%- encodeURIComponent(testStatus.id) %>"><button class="btn view">View log</button></a>
    		<hr />
    		<ul class="browser"></ul>
		</div>
    </script>

    <!-- Running Test: Exposed -->
    <script type="text/template" id="indexTemplate_RunningTestExposedKeyValues">
    	<li><b><%- key %></b>: <i><%- val %></i></li>
    </script>

    <!-- Running Test: ExternalURL -->
    <script type="text/template" id="indexTemplate_RunningTestExternalURL">
    	<li>Go to URL: <a id="browserLink-<%- testId %>-<%- index %>" href="#"><span class="externalURLLink"><%- url %></span></a></li>
    </script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/javascript" src="js/fapi.ui.js"></script>

	<script type="text/javascript">
		
	    /**
	     * 
	     */
		$(function() {

			FAPI_UI.loadHomepageTemplates();
			
			$.getJSON('runner/available', function(data) {
				console.log('available: ', JSON.stringify(data));
				_.each(data, function(testName, index) {
					$('#launch-buttons').append(FAPI_UI.logTemplates.TEST_LAUNCH_BUTTON({testName:testName, index:index}));

					$('#createTestBtn-'+index).click(function (evt) {
						console.log('Button clicked: ' + testName);
						$("#busy").show();

						$.ajax({url: 'runner/?test=' + encodeURIComponent(testName) + '&alias=' + encodeURIComponent($('#alias').val()),
								type: 'POST',
								contentType: 'application/json',
								data: $('#config').val(),
								success: function(data, status) {
									$("#busy").hide();
									console.log('start results: ', data);
									updateRunningTable();
								},
								error: function(jqxhr, status, error) {
									$("#busy").hide();
									alert("Error:"+status);
								},
								dataType: 'json'
						});
					});
				});
			});
			
			updateRunningTable();
			
			$('#refresh').click(function(event) {
				updateRunningTable();
			});
			
		});

		/**
	     * 
	     */
		function updateRunningTable() {
			$.getJSON('runner/running', function(data) {
				console.log('running: ', JSON.stringify(data));
				$('#running-tests').html('');
				
				_.each(data, function(testId) {
					$.getJSON('runner/' + encodeURIComponent(testId), function(status) {
						console.log("displaying test results:"+JSON.stringify(status));

						$('#running-tests').append(FAPI_UI.logTemplates.RUNNING_TEST({testStatus:status}));

						_.each(status.exposed, function(val, key) {
			                $('#'+status.id+' .exposed').append(FAPI_UI.logTemplates.RUNNING_TEST_EXPOSED_KEY_VALUES({key:key, val:val}));
						});

						// Create start & stop button click handlers
						$('#'+status.id+' button.start').click(function (evt) {
							console.log('Start button clicked: ' + testId);
							$.ajax({url: 'runner/' + encodeURIComponent(testId),
						    	type: 'POST',
						    	success: function(data, status) {
		                            console.log('Status: ', status);                                                    
		                            updateRunningTable();
						    	}
						    });
						});

						$('#'+status.id+' button.stop').click(function (evt) {
							console.log('Stop button clicked: ' + testId);
							$.ajax({url: 'runner/' + encodeURIComponent(testId),
		                        type: 'DELETE',
		                        success: function(data, status) {
		                            console.log('Status: ', status);                                                    
		                            updateRunningTable();
		                        }
		                    });
						});

						// External URL link
						$.getJSON('runner/browser/' + encodeURIComponent(testId), function(browser) {
							_.each(browser.urls, function(url, index) {
								$('#'+status.id+' .browser').append(FAPI_UI.logTemplates.RUNNING_TEST_EXTERNAL_URL({testId:testId, url:url, index:index}));
								
								// add the click handler
								$('#browserLink-'+testId+"-"+index).click(function(event) {
									event.preventDefault();
									var win = window.open(url, '_blank');
									
									if (win) {
										win.focus();
										$.ajax({url: 'runner/browser/' + encodeURIComponent(testId) + '/visit?url=' + encodeURIComponent(url),
											type: 'POST',
											success: function(data, status) {
												console.log('Status: ', status);													
												updateRunningTable();
											}
										});
									} else {
										// couldn't open the link?
										console.log("Couldn't launch window");
									}
								});
							});						
						});
					});
				});
			});
		}

	</script>

  </body>
</html>
